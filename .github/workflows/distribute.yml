name: Distribute to firebase

on:
  push:
    branches: [develop, main, hotfix/fastlane-github-action]

jobs:
  distribute:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'

      - name: Install Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '2.7.0'
          bundler-cache: true

      - name: Install Fastlane
        run: cd android && bundle install && cd ..

      - name: Install packages
        run: yarn install

        ## configure cash for gradle : will help to reduce build time

      - name: Cache Gradle Wrapper
        uses: actions/cache@v2
        with:
          path: ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('gradle/wrapper/gradle-wrapper.properties') }}

      - name: Cache Gradle Dependencies
        uses: actions/cache@v2
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-caches-${{ hashFiles('gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-caches-

      # - name: Configure Keystore
      #   run: |
      #     echo "$ANDROID_KEYSTORE_FILE" > keystore.jks.b64
      #     base64 -d -i keystore.jks.b64 > app/keystore.jks
      #     echo "storeFile=keystore.jks" >> keystore.properties
      #     echo "keyAlias=$KEYSTORE_KEY_ALIAS" >> keystore.properties
      #     echo "storePassword=$KEYSTORE_STORE_PASSWORD" >> keystore.properties
      #     echo "keyPassword=$KEYSTORE_KEY_PASSWORD" >> keystore.properties
      #   env:
      #     ANDROID_KEYSTORE_FILE: ${{ secrets.ANDROID_KEYSTORE_FILE }}
      #     KEYSTORE_KEY_ALIAS: ${{ secrets.KEYSTORE_KEY_ALIAS }}
      #     KEYSTORE_KEY_PASSWORD: ${{ secrets.KEYSTORE_KEY_PASSWORD }}
      #     KEYSTORE_STORE_PASSWORD: ${{ secrets.KEYSTORE_STORE_PASSWORD }}

      - name: Create Firebase Service Credentials file
        run: |
          cd android && echo "$FIREBASE_CREDENTIALS" > firebase_credentials.json.b64
          base64 -d -i firebase_credentials.json.b64 > firebase_credentials.json && cd ..
        env:
          FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}

      - name: Distribute app with ðŸ”¥ App Distribution ðŸš€
        run: echo $FIREBASE_APP_ID && yarn android:beta
        env:
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
